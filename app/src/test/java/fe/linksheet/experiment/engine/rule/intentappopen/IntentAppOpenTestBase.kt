package fe.linksheet.experiment.engine.rule.intentappopen

import android.content.Intent
import assertk.assertions.isEqualTo
import assertk.assertions.isInstanceOf
import assertk.assertions.prop
import fe.linksheet.experiment.engine.IntentEngineResult
import fe.linksheet.experiment.engine.LinkEngine
import fe.linksheet.experiment.engine.UrlEngineResult
import fe.linksheet.experiment.engine.rule.LazyTestLinkEngine
import fe.linksheet.experiment.engine.rule.PostprocessorRule
import fe.linksheet.experiment.engine.rule.StepTestResult
import fe.linksheet.experiment.engine.rule.TestLinkModifier
import fe.linksheet.experiment.engine.rule.assertResult
import fe.linksheet.experiment.engine.step.EngineStepId
import fe.std.uri.toStdUrlOrThrow
import kotlinx.coroutines.CoroutineDispatcher
import kotlin.getValue

class IntentAppOpenTestBase(dispatcher: CoroutineDispatcher, rule: PostprocessorRule) {
    private val engine by LazyTestLinkEngine(dispatcher, rule)

    suspend fun `test rule not matched`()  {
        val result = engine.process("https://linksheet.app".toStdUrlOrThrow())
        assertResult(result)
            .isInstanceOf<UrlEngineResult>()
            .prop(UrlEngineResult::url)
            .transform { it.toString() }
            .isEqualTo("https://linksheet.app")
    }

    suspend fun `test rule matched`()  {
        val result = engine.process("https://linksheet.app/fakevideo.mp4".toStdUrlOrThrow())

        assertResult(result)
            .isInstanceOf<IntentEngineResult>()
            .transform { it.intent }
            .prop(Intent::getDataString)
            .isEqualTo("https://linksheet.app/fakevideo.mp4")
    }
}
